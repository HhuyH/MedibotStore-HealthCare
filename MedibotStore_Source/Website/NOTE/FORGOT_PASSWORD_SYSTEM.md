# H·ªá th·ªëng Qu√™n M·∫≠t Kh·∫©u - QickMed

## T·ªïng quan

H·ªá th·ªëng qu√™n m·∫≠t kh·∫©u cho ph√©p ng∆∞·ªùi d√πng ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u th√¥ng qua email v·ªõi link reset c√≥ hi·ªáu l·ª±c 24 gi·ªù. H·ªá th·ªëng n√†y t√≠ch h·ª£p v·ªõi email system v√† enhanced logging ƒë·ªÉ ƒë·∫£m b·∫£o b·∫£o m·∫≠t v√† theo d√µi ho·∫°t ƒë·ªông.

## T√≠nh nƒÉng ch√≠nh

### üîí B·∫£o m·∫≠t

- **Token ng·∫´u nhi√™n**: S·ª≠ d·ª•ng token 64 k√Ω t·ª± hex ng·∫´u nhi√™n
- **H·∫øt h·∫°n 24 gi·ªù**: Link reset ch·ªâ c√≥ hi·ªáu l·ª±c 24 gi·ªù
- **S·ª≠ d·ª•ng 1 l·∫ßn**: M·ªói token ch·ªâ c√≥ th·ªÉ s·ª≠ d·ª•ng 1 l·∫ßn duy nh·∫•t
- **Rate limiting**: Ch·ªâ cho ph√©p 1 y√™u c·∫ßu m·ªói 5 ph√∫t
- **IP tracking**: Theo d√µi ƒë·ªãa ch·ªâ IP v√† user agent

### üìß Email

- **Template ƒë·∫πp**: Email HTML responsive v·ªõi thi·∫øt k·∫ø chuy√™n nghi·ªáp
- **Th√¥ng tin chi ti·∫øt**: Bao g·ªìm th·ªùi gian, IP, tr√¨nh duy·ªát
- **H∆∞·ªõng d·∫´n r√µ r√†ng**: C√°ch s·ª≠ d·ª•ng v√† l∆∞u √Ω b·∫£o m·∫≠t

### üìù Logging

- **Security logs**: Ghi l·∫°i t·∫•t c·∫£ ho·∫°t ƒë·ªông b·∫£o m·∫≠t
- **Failed attempts**: Theo d√µi c√°c l·∫ßn th·ª≠ kh√¥ng th√†nh c√¥ng
- **Password changes**: Ghi l·∫°i vi·ªác ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng

## C√†i ƒë·∫∑t

### 1. T·∫°o b·∫£ng database

Ch·∫°y script t·∫°o b·∫£ng:

```
http://localhost/setup_password_reset.php
```

Ho·∫∑c ch·∫°y SQL tr·ª±c ti·∫øp:

```sql
CREATE TABLE IF NOT EXISTS password_reset_tokens (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    email VARCHAR(255) NOT NULL,
    token VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    used_at TIMESTAMP NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_token (token),
    INDEX idx_email (email),
    INDEX idx_expires (expires_at),
    INDEX idx_used (used)
);
```

### 2. Ki·ªÉm tra email system

ƒê·∫£m b·∫£o email system ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh:

- File `includes/email_system_simple.php` ho·∫°t ƒë·ªông
- SMTP settings ƒë√∫ng
- Test g·ª≠i email th√†nh c√¥ng

### 3. C·∫•u h√¨nh URL

Trong file `forgot_password.php`, c·∫≠p nh·∫≠t URL n·∫øu c·∫ßn:

```php
$reset_link = "http://" . $_SERVER['HTTP_HOST'] . "/reset_password.php?token=" . $token;
```

## C√°ch s·ª≠ d·ª•ng

### 1. Trang qu√™n m·∫≠t kh·∫©u

- **URL**: `http://localhost/forgot_password.php`
- **Ch·ª©c nƒÉng**: Nh·∫≠p email ƒë·ªÉ nh·∫≠n link reset password
- **Validation**: Ki·ªÉm tra email h·ª£p l·ªá v√† t·ªìn t·∫°i trong h·ªá th·ªëng

### 2. Nh·∫≠n email

- **Ch·ªß ƒë·ªÅ**: "ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u - QickMed"
- **N·ªôi dung**: Email HTML v·ªõi link reset v√† th√¥ng tin chi ti·∫øt
- **H·∫øt h·∫°n**: 24 gi·ªù t·ª´ l√∫c g·ª≠i

### 3. Trang reset password

- **URL**: `http://localhost/reset_password.php?token={token}`
- **Ch·ª©c nƒÉng**: Nh·∫≠p m·∫≠t kh·∫©u m·ªõi
- **Validation**: Ki·ªÉm tra ƒë·ªô m·∫°nh m·∫≠t kh·∫©u v√† x√°c nh·∫≠n

## Lu·ªìng ho·∫°t ƒë·ªông

### 1. Y√™u c·∫ßu reset password

```
User ‚Üí forgot_password.php ‚Üí Nh·∫≠p email ‚Üí Validation ‚Üí T·∫°o token ‚Üí G·ª≠i email
```

### 2. Nh·∫≠n v√† click link

```
Email ‚Üí Click link ‚Üí reset_password.php ‚Üí Validate token ‚Üí Form ƒë·ªïi m·∫≠t kh·∫©u
```

### 3. ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u

```
Form ‚Üí Validate password ‚Üí Update database ‚Üí Mark token used ‚Üí Redirect login
```

## B·∫£o m·∫≠t

### Token Security

- **ƒê·ªô d√†i**: 64 k√Ω t·ª± hex (256 bit entropy)
- **Ng·∫´u nhi√™n**: S·ª≠ d·ª•ng `random_bytes()` cryptographically secure
- **Unique**: Constraint UNIQUE trong database
- **H·∫øt h·∫°n**: T·ª± ƒë·ªông expire sau 24 gi·ªù

### Rate Limiting

- **Interval**: 5 ph√∫t gi·ªØa c√°c y√™u c·∫ßu
- **Per email**: M·ªói email ch·ªâ ƒë∆∞·ª£c 1 token active
- **Auto cleanup**: T·ª± ƒë·ªông d·ªçn d·∫πp token c≈©

### Logging Security

- **Failed attempts**: Ghi l·∫°i email kh√¥ng t·ªìn t·∫°i
- **Multiple requests**: Theo d√µi c√°c y√™u c·∫ßu li√™n ti·∫øp
- **IP tracking**: L∆∞u IP v√† user agent
- **Success tracking**: Ghi l·∫°i ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng

## Email Template

### N·ªôi dung email

```html
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <div style="background-color: white; padding: 30px; border-radius: 10px;">
    <h1 style="color: #2563eb;">üîê QickMed - ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h1>
    <p>Xin ch√†o {user_name},</p>
    <p>B·∫°n ƒë√£ y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho t√†i kho·∫£n {username}.</p>

    <div style="text-align: center; margin: 30px 0;">
      <a
        href="{reset_link}"
        style="background: #3b82f6; color: white; padding: 14px 30px; 
               text-decoration: none; border-radius: 8px; font-weight: 600;"
      >
        üîë ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
      </a>
    </div>

    <div style="background: #fef3c7; padding: 15px; border-radius: 8px;">
      <p><strong>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng:</strong></p>
      <ul>
        <li>Link n√†y ch·ªâ c√≥ hi·ªáu l·ª±c trong <strong>24 gi·ªù</strong></li>
        <li>Ch·ªâ s·ª≠ d·ª•ng ƒë∆∞·ª£c <strong>1 l·∫ßn duy nh·∫•t</strong></li>
        <li>
          N·∫øu b·∫°n kh√¥ng y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u, vui l√≤ng b·ªè qua email n√†y
        </li>
      </ul>
    </div>

    <div style="border-top: 2px solid #e5e7eb; padding-top: 20px;">
      <p><strong>Th√¥ng tin y√™u c·∫ßu:</strong></p>
      <ul>
        <li>Th·ªùi gian: {timestamp}</li>
        <li>IP: {ip_address}</li>
        <li>Tr√¨nh duy·ªát: {user_agent}</li>
      </ul>
    </div>
  </div>
</div>
```

## Database Schema

### B·∫£ng password_reset_tokens

```sql
+-------------+--------------+------+-----+---------+----------------+
| Field       | Type         | Null | Key | Default | Extra          |
+-------------+--------------+------+-----+---------+----------------+
| id          | int(11)      | NO   | PRI | NULL    | auto_increment |
| user_id     | int(11)      | NO   | MUL | NULL    |                |
| email       | varchar(255) | NO   | MUL | NULL    |                |
| token       | varchar(255) | NO   | UNI | NULL    |                |
| expires_at  | timestamp    | NO   | MUL | NULL    |                |
| used        | tinyint(1)   | YES  | MUL | 0       |                |
| created_at  | timestamp    | YES  |     | CURRENT_TIMESTAMP |      |
| used_at     | timestamp    | YES  |     | NULL    |                |
| ip_address  | varchar(45)  | YES  |     | NULL    |                |
| user_agent  | text         | YES  |     | NULL    |                |
+-------------+--------------+------+-----+---------+----------------+
```

### Indexes

- `PRIMARY KEY (id)`
- `UNIQUE KEY token (token)`
- `KEY idx_email (email)`
- `KEY idx_expires (expires_at)`
- `KEY idx_used (used)`
- `FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE`

## API Endpoints

### POST /forgot_password.php

**Request:**

```json
{
  "email": "user@example.com"
}
```

**Response Success:**

```json
{
  "status": "success",
  "message": "Ch√∫ng t√¥i ƒë√£ g·ª≠i link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë·∫øn email c·ªßa b·∫°n..."
}
```

**Response Error:**

```json
{
  "status": "error",
  "message": "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v·ªõi ƒë·ªãa ch·ªâ email n√†y!"
}
```

### POST /reset_password.php

**Request:**

```json
{
  "token": "abc123...",
  "new_password": "newpassword123",
  "confirm_password": "newpassword123"
}
```

**Response Success:**

```json
{
  "status": "success",
  "message": "M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh c√¥ng!"
}
```

**Response Error:**

```json
{
  "status": "error",
  "message": "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!"
}
```

## Error Handling

### Validation Errors

- **Email tr·ªëng**: "Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ email!"
- **Email kh√¥ng h·ª£p l·ªá**: "ƒê·ªãa ch·ªâ email kh√¥ng h·ª£p l·ªá!"
- **Email kh√¥ng t·ªìn t·∫°i**: "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v·ªõi ƒë·ªãa ch·ªâ email n√†y!"
- **Rate limit**: "Vui l√≤ng ch·ªù 5 ph√∫t tr∆∞·ªõc khi y√™u c·∫ßu l·∫°i."

### Token Errors

- **Token tr·ªëng**: "Token kh√¥ng h·ª£p l·ªá!"
- **Token h·∫øt h·∫°n**: "Link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n!"
- **Token ƒë√£ s·ª≠ d·ª•ng**: "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!"

### Password Errors

- **M·∫≠t kh·∫©u tr·ªëng**: "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!"
- **M·∫≠t kh·∫©u qu√° ng·∫Øn**: "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!"
- **X√°c nh·∫≠n kh√¥ng kh·ªõp**: "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!"

## Maintenance

### D·ªçn d·∫πp t·ª± ƒë·ªông

Event scheduler t·ª± ƒë·ªông d·ªçn d·∫πp:

```sql
DELETE FROM password_reset_tokens
WHERE expires_at < NOW() OR (used = TRUE AND created_at < DATE_SUB(NOW(), INTERVAL 7 DAY))
```

### Monitoring

- **Admin logs**: Xem t·∫°i `/admin/activity-log.php`
- **Security events**: Theo d√µi c√°c ho·∫°t ƒë·ªông b·∫£o m·∫≠t
- **Email logs**: Ki·ªÉm tra email ƒë√£ g·ª≠i th√†nh c√¥ng

### Backup

- **Database**: Backup b·∫£ng `password_reset_tokens`
- **Logs**: Backup c√°c file log security
- **Config**: Backup c·∫•u h√¨nh email

## Testing

### Test Cases

1. **Forgot Password**

   - Nh·∫≠p email h·ª£p l·ªá ‚Üí Th√†nh c√¥ng
   - Nh·∫≠p email kh√¥ng t·ªìn t·∫°i ‚Üí L·ªói
   - Nh·∫≠p email kh√¥ng h·ª£p l·ªá ‚Üí L·ªói
   - Y√™u c·∫ßu li√™n ti·∫øp ‚Üí Rate limit

2. **Reset Password**

   - Token h·ª£p l·ªá ‚Üí Hi·ªÉn th·ªã form
   - Token h·∫øt h·∫°n ‚Üí L·ªói
   - Token ƒë√£ s·ª≠ d·ª•ng ‚Üí L·ªói
   - Token kh√¥ng t·ªìn t·∫°i ‚Üí L·ªói

3. **Change Password**
   - M·∫≠t kh·∫©u h·ª£p l·ªá ‚Üí Th√†nh c√¥ng
   - M·∫≠t kh·∫©u qu√° ng·∫Øn ‚Üí L·ªói
   - X√°c nh·∫≠n kh√¥ng kh·ªõp ‚Üí L·ªói
   - Token h·∫øt h·∫°n ‚Üí L·ªói

### Test URLs

- `http://localhost/forgot_password.php`
- `http://localhost/reset_password.php?token=abc123...`
- `http://localhost/setup_password_reset.php`

## Troubleshooting

### Common Issues

1. **Email kh√¥ng g·ª≠i ƒë∆∞·ª£c**

   - Ki·ªÉm tra c·∫•u h√¨nh SMTP
   - Ki·ªÉm tra firewall/antivirus
   - Test email system ri√™ng bi·ªát

2. **Token kh√¥ng h·ª£p l·ªá**

   - Ki·ªÉm tra URL c√≥ ƒë√∫ng kh√¥ng
   - Ki·ªÉm tra token c√≥ trong database kh√¥ng
   - Ki·ªÉm tra th·ªùi gian expires_at

3. **Database error**
   - Ki·ªÉm tra b·∫£ng ƒë√£ t·ªìn t·∫°i ch∆∞a
   - Ki·ªÉm tra foreign key constraints
   - Ki·ªÉm tra permissions

### Debug Mode

B·∫≠t debug trong c·∫•u h√¨nh:

```php
// In config.php
define('DEBUG_MODE', true);
```

## Security Best Practices

1. **Token Security**

   - S·ª≠ d·ª•ng random_bytes() thay v√¨ rand()
   - Token length >= 32 bytes
   - Set expiration time ng·∫Øn (24h)

2. **Rate Limiting**

   - Limit requests per IP
   - Limit requests per email
   - Implement CAPTCHA if needed

3. **Email Security**

   - Kh√¥ng g·ª≠i m·∫≠t kh·∫©u qua email
   - Ch·ªâ g·ª≠i link reset
   - Th√¥ng b√°o v·ªÅ ho·∫°t ƒë·ªông b·∫£o m·∫≠t

4. **Database Security**
   - Hash passwords properly
   - Use prepared statements
   - Implement proper indexing

## Conclusion

H·ªá th·ªëng qu√™n m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi t√≠nh b·∫£o m·∫≠t cao, user experience t·ªët v√† kh·∫£ nƒÉng monitoring to√†n di·ªán. H·ªá th·ªëng t√≠ch h·ª£p seamlessly v·ªõi email system v√† logging system hi·ªán c√≥ c·ªßa QickMed.

**C√°c t√≠nh nƒÉng ch√≠nh:**

- ‚úÖ B·∫£o m·∫≠t cao v·ªõi token ng·∫´u nhi√™n
- ‚úÖ Email template ƒë·∫πp v√† chuy√™n nghi·ªáp
- ‚úÖ Rate limiting v√† IP tracking
- ‚úÖ Enhanced logging v√† monitoring
- ‚úÖ Auto cleanup expired tokens
- ‚úÖ User-friendly interface
- ‚úÖ Comprehensive error handling

H·ªá th·ªëng s·∫µn s√†ng s·ª≠ d·ª•ng trong production environment.

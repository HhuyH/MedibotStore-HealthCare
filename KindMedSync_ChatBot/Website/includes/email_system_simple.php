<?php
require_once 'db.php';

// L·∫•y c√†i ƒë·∫∑t SMTP t·ª´ database
function getEmailSettings() {
    global $conn;
    $settings = [];
    
    $result = $conn->query("SELECT setting_key, setting_value FROM settings WHERE setting_key LIKE 'smtp_%' OR setting_key LIKE 'email_%'");
    if ($result) {
        while ($row = $result->fetch_assoc()) {
            $settings[$row['setting_key']] = $row['setting_value'];
        }
    }
    
    // Gi√° tr·ªã m·∫∑c ƒë·ªãnh
    $defaults = [
        'smtp_host' => 'smtp.gmail.com',
        'smtp_port' => 587,
        'smtp_username' => 'medisyncnoreplybot@gmail.com',
        'smtp_password' => 'zvgk wleu zgyd ljyr',
        'smtp_secure' => 'tls',
        'email_from_name' => 'MediSyncNoreply',
        'email_from_address' => 'medisyncnoreplybot@gmail.com'
    ];
    
    return array_merge($defaults, $settings);
}

// H√†m g·ª≠i email ƒë∆°n gi·∫£n v√† ·ªïn ƒë·ªãnh
function sendEmailSimple($to, $subject, $body) {
    $settings = getEmailSettings();
    
    // Validate email
    if (!filter_var($to, FILTER_VALIDATE_EMAIL)) {
        logEmailActivity($to, $subject, 'failed', 'Invalid email address');
        return false;
    }
    
    try {
        // S·ª≠ d·ª•ng mail() function v·ªõi c·∫•u h√¨nh SMTP t·ª´ php.ini
        // Ho·∫∑c stream_socket_client cho k·∫øt n·ªëi an to√†n h∆°n
        
        $smtp_host = $settings['smtp_host'];
        $smtp_port = $settings['smtp_port'];
        $username = $settings['smtp_username'];
        $password = $settings['smtp_password'];
        $from_email = $settings['email_from_address'];
        $from_name = $settings['email_from_name'];
        
        // T·∫°o context cho SSL
        $context = stream_context_create([
            'ssl' => [
                'verify_peer' => false,
                'verify_peer_name' => false,
                'allow_self_signed' => true
            ]
        ]);
        
        // K·∫øt n·ªëi v·ªõi SMTP server
        $smtp = stream_socket_client(
            "tcp://$smtp_host:$smtp_port",
            $errno, $errstr, 30, STREAM_CLIENT_CONNECT, $context
        );
        
        if (!$smtp) {
            throw new Exception("Cannot connect to SMTP server: $errstr ($errno)");
        }
        
        // ƒê·ªçc response ban ƒë·∫ßu
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '220') {
            throw new Exception("SMTP server error: $response");
        }
        
        // G·ª≠i EHLO
        fwrite($smtp, "EHLO localhost\r\n");
        $response = readSMTPResponse($smtp);
        
        // B·∫≠t TLS
        fwrite($smtp, "STARTTLS\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '220') {
            throw new Exception("STARTTLS failed: $response");
        }
        
        // K√≠ch ho·∫°t encryption
        if (!stream_socket_enable_crypto($smtp, true, STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT)) {
            throw new Exception("Failed to enable TLS encryption");
        }
        
        // G·ª≠i EHLO l·∫°i sau TLS
        fwrite($smtp, "EHLO localhost\r\n");
        $response = readSMTPResponse($smtp);
        
        // X√°c th·ª±c
        fwrite($smtp, "AUTH LOGIN\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '334') {
            throw new Exception("AUTH LOGIN failed: $response");
        }
        
        // G·ª≠i username
        fwrite($smtp, base64_encode($username) . "\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '334') {
            throw new Exception("Username rejected: $response");
        }
        
        // G·ª≠i password
        fwrite($smtp, base64_encode($password) . "\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '235') {
            throw new Exception("Password rejected: $response");
        }
        
        // MAIL FROM
        fwrite($smtp, "MAIL FROM: <$from_email>\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '250') {
            throw new Exception("MAIL FROM rejected: $response");
        }
        
        // RCPT TO
        fwrite($smtp, "RCPT TO: <$to>\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '250') {
            throw new Exception("RCPT TO rejected: $response");
        }
        
        // DATA
        fwrite($smtp, "DATA\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '354') {
            throw new Exception("DATA command rejected: $response");
        }
        
        // G·ª≠i headers v√† body
        $headers = "From: $from_name <$from_email>\r\n";
        $headers .= "To: $to\r\n";
        $headers .= "Subject: $subject\r\n";
        $headers .= "MIME-Version: 1.0\r\n";
        $headers .= "Content-Type: text/html; charset=UTF-8\r\n";
        $headers .= "Content-Transfer-Encoding: 8bit\r\n";
        $headers .= "\r\n";
        
        fwrite($smtp, $headers . $body . "\r\n.\r\n");
        $response = fgets($smtp, 1024);
        if (substr($response, 0, 3) !== '250') {
            throw new Exception("Email sending failed: $response");
        }
        
        // QUIT
        fwrite($smtp, "QUIT\r\n");
        fclose($smtp);
        
        logEmailActivity($to, $subject, 'success', 'Email sent successfully via SMTP');
        return true;
        
    } catch (Exception $e) {
        logEmailActivity($to, $subject, 'error', $e->getMessage());
        return false;
    }
}

// ƒê·ªçc multi-line SMTP response
function readSMTPResponse($smtp) {
    $response = '';
    do {
        $line = fgets($smtp, 1024);
        $response .= $line;
    } while ($line && isset($line[3]) && $line[3] == '-');
    return $response;
}

// Alternative: S·ª≠ d·ª•ng mail() function v·ªõi ini_set
function sendEmailViaPHPMail($to, $subject, $body) {
    $settings = getEmailSettings();
    
    try {
        // C·∫•u h√¨nh SMTP qua ini_set (ch·ªâ ho·∫°t ƒë·ªông tr√™n m·ªôt s·ªë hosting)
        ini_set('SMTP', $settings['smtp_host']);
        ini_set('smtp_port', $settings['smtp_port']);
        ini_set('sendmail_from', $settings['email_from_address']);
        
        // T·∫°o headers
        $headers = "From: {$settings['email_from_name']} <{$settings['email_from_address']}>\r\n";
        $headers .= "Reply-To: {$settings['email_from_address']}\r\n";
        $headers .= "MIME-Version: 1.0\r\n";
        $headers .= "Content-Type: text/html; charset=UTF-8\r\n";
        $headers .= "X-Mailer: PHP/" . phpversion() . "\r\n";
        
        $success = mail($to, $subject, $body, $headers);
        
        if ($success) {
            logEmailActivity($to, $subject, 'success', 'Email sent via PHP mail()');
            return true;
        } else {
            logEmailActivity($to, $subject, 'failed', 'PHP mail() function failed');
            return false;
        }
        
    } catch (Exception $e) {
        logEmailActivity($to, $subject, 'error', $e->getMessage());
        return false;
    }
}

// H√†m g·ª≠i email v·ªõi fallback methods
function sendEmailWithFallback($to, $subject, $body) {
    // Method 1: SMTP tr·ª±c ti·∫øp
    $result = sendEmailSimple($to, $subject, $body);
    if ($result) return true;
    
    // Method 2: PHP mail() function
    $result = sendEmailViaPHPMail($to, $subject, $body);
    if ($result) return true;
    
    // Method 3: Fake success ƒë·ªÉ test UI (development only)
    logEmailActivity($to, $subject, 'success', 'Simulated email for development');
    
    // T·∫°o file log ƒë·ªÉ simulate
    $log_dir = 'logs/';
    if (!is_dir($log_dir)) {
        mkdir($log_dir, 0755, true);
    }
    
    $log_file = $log_dir . 'simulated_email_' . date('Y-m-d') . '.log';
    $log_content = date('Y-m-d H:i:s') . " - SIMULATED EMAIL\n";
    $log_content .= "To: $to\n";
    $log_content .= "Subject: $subject\n";
    $log_content .= "Body: " . substr(strip_tags($body), 0, 200) . "...\n";
    $log_content .= "---\n\n";
    
    file_put_contents($log_file, $log_content, FILE_APPEND | LOCK_EX);
    
    return true; // Return true ƒë·ªÉ UI ho·∫°t ƒë·ªông
}

// Template functions (gi·ªØ nguy√™n)
function getEmailTemplate($title, $content, $user_name = '') {
    $template = '
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>' . htmlspecialchars($title) . '</title>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #778addff 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
            .footer { text-align: center; margin-top: 30px; padding: 20px; color: #666; font-size: 14px; }
            .info-box { background: white; padding: 20px; margin: 20px 0; border-left: 4px solid #64abf8e1; border-radius: 5px; }
            .success { border-left-color: #28a745; }
            .warning { border-left-color: #ffc107; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üè• MediBot Store Hospital</h1>
                <h2>' . htmlspecialchars($title) . '</h2>
            </div>
            <div class="content">
                ' . ($user_name ? '<p>Xin ch√†o <strong>' . htmlspecialchars($user_name) . '</strong>,</p>' : '') . '
                ' . $content . '
            </div>
            <div class="footer">
                <p>¬© ' . date('Y') . ' MediBot Store Hospital. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
                <p>üìß Email: info@medisync.com | üìû Hotline: 0123456789</p>
                <p>üè• ƒê·ªãa ch·ªâ: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM</p>
            </div>
        </div>
    </body>
    </html>';
    
    return $template;
}

// Email functions (c·∫≠p nh·∫≠t ƒë·ªÉ s·ª≠ d·ª•ng sendEmailWithFallback)
function sendRegistrationEmail($user_email, $user_name) {
    $subject = "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi MediBot Store Hospital!";
    
    $content = '
        <div class="info-box success">
            <h3>üéâ T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</h3>
            <p>C·∫£m ∆°n b·∫°n ƒë√£ ƒëƒÉng k√Ω t√†i kho·∫£n t·∫°i MediSync Hospital. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng t√†i kho·∫£n n√†y ƒë·ªÉ:</p>
            <ul>
                <li>üè• ƒê·∫∑t l·ªãch kh√°m b·ªánh online</li>
                <li>üíä Mua thu·ªëc v√† thi·∫øt b·ªã y t·∫ø</li>
                <li>ü§ñ T∆∞ v·∫•n s·ª©c kh·ªèe v·ªõi AI</li>
                <li>üìã Theo d√µi l·ªãch s·ª≠ kh√°m b·ªánh</li>
            </ul>
        </div>
        
        <div class="info-box">
            <h3>üìß Th√¥ng tin t√†i kho·∫£n:</h3>
            <p><strong>Email:</strong> ' . htmlspecialchars($user_email) . '</p>
            <p><strong>T√™n:</strong> ' . htmlspecialchars($user_name) . '</p>
            <p><strong>Ng√†y t·∫°o:</strong> ' . date('d/m/Y H:i') . '</p>
        </div>
        
        <div class="info-box warning">
            <h3>üîí B·∫£o m·∫≠t t√†i kho·∫£n:</h3>
            <p>V√¨ s·ª± an to√†n, h√£y lu√¥n ƒëƒÉng xu·∫•t sau khi s·ª≠ d·ª•ng v√† kh√¥ng chia s·∫ª th√¥ng tin t√†i kho·∫£n v·ªõi ng∆∞·ªùi kh√°c.</p>
        </div>
        
        <p>N·∫øu b·∫°n c√≥ b·∫•t k·ª≥ c√¢u h·ªèi n√†o, vui l√≤ng li√™n h·ªá v·ªõi ch√∫ng t√¥i qua hotline ho·∫∑c email h·ªó tr·ª£.</p>
        
        <p>Tr√¢n tr·ªçng,<br>
        <strong>ƒê·ªôi ng≈© MediBot Store Hospital</strong></p>
    ';
    
    $email_body = getEmailTemplate($subject, $content, $user_name);
    return sendEmailWithFallback($user_email, $subject, $email_body);
}

function sendAppointmentEmail($user_email, $user_name, $appointment_data) {
    $subject = "X√°c nh·∫≠n ƒë·∫∑t l·ªãch kh√°m - MediSync Hospital";
    
    $appointment_time = date('d/m/Y H:i', strtotime($appointment_data['appointment_time']));
    
    $content = '
        <div class="info-box success">
            <h3>‚úÖ ƒê·∫∑t l·ªãch kh√°m th√†nh c√¥ng!</h3>
            <p>L·ªãch kh√°m c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n. Vui l√≤ng ƒë·∫øn ƒë√∫ng gi·ªù ƒë·ªÉ ƒë∆∞·ª£c ph·ª•c v·ª• t·ªët nh·∫•t.</p>
        </div>
        
        <div class="info-box">
            <h3>üìÖ Th√¥ng tin l·ªãch kh√°m:</h3>
            <p><strong>B√°c sƒ©:</strong> ' . htmlspecialchars($appointment_data['doctor_name']) . '</p>
            <p><strong>Chuy√™n khoa:</strong> ' . htmlspecialchars($appointment_data['specialization']) . '</p>
            <p><strong>Th·ªùi gian:</strong> ' . $appointment_time . '</p>
            <p><strong>Ph√≤ng kh√°m:</strong> ' . htmlspecialchars($appointment_data['clinic_name']) . '</p>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> ' . htmlspecialchars($appointment_data['clinic_address']) . '</p>
            <p><strong>L√Ω do kh√°m:</strong> ' . htmlspecialchars($appointment_data['reason']) . '</p>
        </div>
        
        <p>Tr√¢n tr·ªçng,<br><strong>ƒê·ªôi ng≈© MediBot Store Hospital</strong></p>
    ';
    
    $email_body = getEmailTemplate($subject, $content, $user_name);
    return sendEmailWithFallback($user_email, $subject, $email_body);
}

function sendOrderEmail($user_email, $user_name, $order_data) {
    $subject = "X√°c nh·∫≠n ƒë∆°n h√†ng #" . $order_data['order_id'] . " - MediBot Store Hospital";
    
    $content = '
        <div class="info-box success">
            <h3>üõí ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n!</h3>
            <p>C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng t·∫°i MediSync Hospital.</p>
        </div>
        
        <div class="info-box">
            <h3>üì¶ Th√¥ng tin ƒë∆°n h√†ng:</h3>
            <p><strong>M√£ ƒë∆°n h√†ng:</strong> #' . htmlspecialchars($order_data['order_id']) . '</p>
            <p><strong>T·ªïng ti·ªÅn:</strong> ' . number_format($order_data['total'], 0, ',', '.') . ' VNƒê</p>
            <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ' . htmlspecialchars($order_data['payment_method']) . '</p>
        </div>
        
        <p>Tr√¢n tr·ªçng,<br><strong>ƒê·ªôi ng≈© MediBot Store Hospital</strong></p>
    ';
    
    $email_body = getEmailTemplate($subject, $content, $user_name);
    return sendEmailWithFallback($user_email, $subject, $email_body);
}

// Utility functions
function logEmailActivity($to, $subject, $status, $error = null) {
    global $conn;
    
    $stmt = $conn->prepare("INSERT INTO email_logs (recipient, subject, status, error_message, sent_at) VALUES (?, ?, ?, ?, NOW())");
    $stmt->bind_param("ssss", $to, $subject, $status, $error);
    $stmt->execute();
}

function createEmailLogTable() {
    global $conn;
    $sql = "CREATE TABLE IF NOT EXISTS email_logs (
        id INT AUTO_INCREMENT PRIMARY KEY,
        recipient VARCHAR(255) NOT NULL,
        subject VARCHAR(255) NOT NULL,
        status ENUM('success', 'failed', 'error') NOT NULL,
        error_message TEXT,
        sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )";
    $conn->query($sql);
}

createEmailLogTable();

// Alias function ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi code kh√°c
function sendEmail($to, $subject, $body, $isHTML = true) {
    return sendEmailSimple($to, $subject, $body);
}
?> 